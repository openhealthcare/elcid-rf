{% load panels %}
{% load forms %}
<div ng-if="view === 'test_results'">
  <div ng-controller="ResultView as resultView" class="col-md-12 lab-tests">
    <div class="panel panel-default">
      <div class="panel-heading">
        <div class="row">
          <div class="col-md-6">
            <h3>
              Lab Tests <i class="fa fa-flask"></i>
            </h3>
          </div>
          <div class="col-md-6 text-right">
            <div class="btn-group" uib-dropdown is-open="status.isopen">
              <button type="button" class="btn btn-secondary" uib-dropdown-toggle ng-disabled="disabled" id="list-dropdown">
                <i class="fa fa-user-md"></i>
                  [[ resultView.currentTag ]]
                <i class="fa fa-angle-down"></i>
              </button>
              <ul class="uib-dropdown-menu slides" role="menu" aria-labelledby="list-dropdown">
                <li ng-show="tag !== resultView.currentTag" ng-repeat="tag in resultView.tags">
                  <a ng-click="resultView.filter(tag)">
                    [[ tag ]]
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <ul class="list-group">
        <li class="list-group-item " ng-repeat="labTest in resultView.labTests">
          <div class="content-offset-below">
            <div class="row">
              <div class="col-md-6">
                <h5>[[ labTest.lab_test_type ]]</h5>
              </div>
              <div class="text-right col-md-6">
                <span ng-repeat="tag in labTest.tags">
                  <a ng-click="resultView.filter(tag)" class="btn btn-default pointer btn-sm">[[ tag ]]</a>
                </span>
              </div>
            </div>
            <div ng-show="labTest.observations.length">
              <div ng-if="labTest.long_form">
                <div ng-repeat="obsDate in labTest.observation_date_range track by $index" class="row">
                  <div class="col-md-12">
                    <h5>[[ obsDate|shortDate ]]</h5>
                    <div ng-repeat="observation_name in labTest.observation_names">
                      <div class="row">
                        <div class="col-md-12">
                          <p>
                            [[ observation_name ]] - [[ labTest.by_observations[observation_name][obsDate].observation_value ]]
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div ng-if="!labTest.long_form">
                <div class="row lab-test-row content-offset-below-10">
                  <div class="col-sm-3">
                  </div>
                  <div class="col-sm-1">
                    Range
                  </div>
                  <div ng-repeat="obsDate in labTest.observation_date_range | limitTo:6 track by $index" class="col-sm-1">
                      [[ obsDate|shortDate ]]
                  </div>
                </div>
                <div ng-repeat="observation_name in labTest.observation_names">
                  <div {# we need to remove this for the time being - ng-click="resultView.showObservation(labTest, observation_name)" #}class="lab-test-row selectable row">
                    <div class="col-sm-3">
                      <span class="too-high" ng-show="resultView.trendChange(labTest, observation_name) === 1">
                        {% icon "fa-chevron-circle-up" %}
                      </span>
                      <span class="too-high" ng-show="resultView.trendChange(labTest, observation_name) === -1">
                        {% icon "fa-chevron-circle-down" %}
                      </span>
                      <span ng-show="!resultView.trendChange(labTest, observation_name)">
                        {% icon "fa-chevron-circle-right" %}
                      </span>
                      [[ observation_name ]]
                      <span ng-show="labTest.observation_metadata[observation_name].units && labTest.observation_metadata[observation_name].units.length">
                        ([[ labTest.observation_metadata[observation_name].units ]])
                      </span>
                    </div>
                    <div class="text-muted col-sm-1">
                      [[ labTest.observation_metadata[observation_name].reference_range.min ]]
                      -
                      [[ labTest.observation_metadata[observation_name].reference_range.max ]]
                    </div>
                    <div ng-class="{'too-high': labTest.by_observations[observation_name][obsDate].observation_value > labTest.observation_metadata[observation_name].reference_range.max, 'too-high': labTest.by_observations[observation_name][obsDate].observation_value < labTest.observation_metadata[observation_name].reference_range.min}" ng-repeat="obsDate in labTest.observation_date_range | limitTo:6 track by $index" class="col-sm-1">
                      [[ labTest.by_observations[observation_name][obsDate].observation_value ]]
                    </div>
                  </div>
                  <div ng-show="resultView.isShownObservation(labTest, observation_name)" class="row">
                    <div class="col-md-12">
                      <div class="observation-graph-pane" ng-show="resultView.observationDetail[observation_name]">
                        <div ng-if="resultView.observationDetail[labTest.lab_test_type][observation_name].length">
                          <div observation-name="observation_name" observation-range="labTest.observation_metadata[observation_name].reference_range" observation-graph="resultView.observationDetail[labTest.lab_test_type][observation_name]"></div>
                        </div>
                        <div ng-show="!resultView.observationDetail[labTest.lab_test_type][observation_name].length">
                          <div class="row">
                            <div class="result-loading col-md-12 text-center">
                              <h3>
                                <i class="fa fa-cog fa-spin"></i> Loading...
                              </h3>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div ng-show="!$last" class="row ">
                    <div class="col-md-12">
                      <hr />
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </li>
      </ul>
    </div>
  </div>
</div>
