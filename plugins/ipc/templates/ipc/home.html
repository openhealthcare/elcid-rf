{% extends 'ipc/base.html' %}
{% block content %}
<div class="panel panel-default">
  <div class="panel-heading">
    <h1>Infection Prevention & Control: Royal Free Hospital</h1>
  </div> <!-- Heading -->

  <div class="panel-body">

    {% if alerts %}
    <h2>{{ alerts| length }} New Infection Alerts</h2>
    {% endif %}

    {% for alert in alerts %}
    <div class="row {% if not alert.seen %} bg-danger {% endif %}">

      <div class="col-md-1">{{ alert.category }}</div>
      <div class="col-md-2">{{ alert.trigger_datetime }}</div>
      <div class="col-md-1">{{ alert.lab_test.lab_number }}</div>

      {% with alert.episode.patient.demographics as demographics %}
      <div class="col-md-1">
        <a class="orange-link" href="/#/patient/{{ demographics.patient_id }}/{{ alert.episode_id }}">
          {{ demographics.hospital_number }}</a>
      </div>
      <div class="col-md-2">
        <a class="orange-link" href="/#/patient/{{ demographics.patient_id }}/{{ alert.episode_id }}">
          {{ demographics.name }}</a>
      </div>
      <div class="col-md-1">
        <a class="orange-link" href="/#/patient/{{ demographics.patient_id }}/{{ alert.episode_id }}">
          {{ demographics.date_of_birth }}</a>
      </div>
      {% endwith %}
      <div class="col-md-2">
        {% with alert.episode.patient.upstreamlocation.get as location %}
        <a href="/#/ipc/ward/{{ location.ward | slugify }}/" class="orange-link">
          {{ location.ward }}
        </a>
        {{ location.room }} {{ location.bed }}
        {% endwith %}
      </div>
    </div> <!-- Row -->
    {% endfor %}

    <h2>Hospital Status</h2>
    <div class="row text-center">
      <div class="col-md-4">
        <h2>Patients</h2>
        <h1>{{ rfh_patients }}</h1>
        <p>Total current inpatients</p>
      </div>

      <div class="col-md-4">
        <h2>Siderooms</h2>
        <h1>{{ rfh_siderooms }}</h1>
        <p>Currently occupied siderooms</p>
      </div>

      <div class="col-md-4">
        <h2>Alerts</h2>
        <h1>{{ weekly_alerts }}</h1>
        <p>Alerts in the last 7 days</p>
      </div>


    </div>

    <h2>12 Month Infections</h2>
    <div class="row">
      <div class="col-md-12">
        <div id="overview"></div>
      </div>
    </div>

  </div> <!-- Panel body -->

</div> <!-- Panel -->

<script>
  c3.generate(
      {
          bindto: document.getElementById('overview'),
          data: {
              columns: {{ overview_data |safe }},
              x: 'x',
              type: 'bar'
          },
          axis: {
              x: {
                  type: 'timeseries',
                  tick: { format: '%b %Y', rotate: 45}
              }
          },
          point: {
              show: false
          },
          bar: {
              width: {
                  ratio: 0.66
              }
          }
      }
  )
</script>
{% endblock %}
